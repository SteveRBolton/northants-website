<?php

/**
 * Implements hook_search_api_solr_query_alter
 *
 * @param \Solarium\Core\Query\QueryInterface $solarium_query
 *   The Solarium query object, as generated from the Search API query.
 * @param \Drupal\search_api\Query\QueryInterface $query
 *   The Search API query object representing the executed search query.
 */
function nc_solr_search_api_solr_query_alter(\Solarium\Core\Query\QueryInterface $solarium_query, \Drupal\search_api\Query\QueryInterface $query) {
  // To get a list of solarium events:
  // @see http://solarium.readthedocs.io/en/stable/customizing-solarium/#plugin-system
  // If the Search API query has a 'my_custom_boost' option, use the edsimax
  // query handler and add some boost queries.

  $solr_field_names = $query->getIndex()
    ->getServerInstance()
    ->getBackend()
    ->getSolrFieldNames($query->getIndex());

//  Drupal::logger('sc_solr')->debug(json_encode($solr_field_names));
  /** @var \Solarium\Component\EdisMax $edismax */
  $edismax = $solarium_query->getEDisMax();

  if ($query->getOption('boost_important')) {
    $solr_important_boost_value = 5.0;
    $boost_important = new \Solarium\Component\DisMax\BoostQuery([
      'key' => 'boost_important',
      'query' => $solr_field_names['important'] . ':true^' . $solr_important_boost_value,
    ]);
    $edismax->addBoostQuery($boost_important);
  }

  if ($query->getOption('boost_keywords_exact')) {
    $solr_keywords_exact_boost_value = 5.0;
    $keys = $query->getOriginalKeys();
    if (is_array($keys)) {
      $keys = implode(' ', $keys);
    }

    if(!empty($keys)) {
      $boost_keywords_exact = new \Solarium\Component\DisMax\BoostQuery([
        'key' => 'boost_keywords_exact',
        'query' => $solr_field_names['keywords'] . ':' . $keys . '^' . $solr_keywords_exact_boost_value,
      ]);
      $edismax->addBoostQuery($boost_keywords_exact);
    }
  }
  // Make sure to use edismax so we can use the boost queries.
  $solarium_query->addParam('defType', 'edismax');
}
